function buildCountryTooltip(e,r){var n=countryTooltip;return n=n.replace("name",e.html()),n=n.replace("count",r.Count)}function buildMarkerTooltip(e,r){var n=markerTooltip;return n=n.replace("description",e[r].desc),n=n.replace("latitude",e[r].Latitude),n=n.replace("longitude",e[r].Longitude)}function buildRegionTooltip(e){var r=regionTooltip;return r=r.replace("name",e.name)}function mapRange(e,r,n,o,t){return o+(t-o)*(e-r)/(n-r)}function generateColorsForTheCountries(e){e||(e=jsonCountries);var r=[];return $.each(e,function(e,n){r[n.Country]=n.Count}),r}function readCountriesFromJSON(e){{var r=[];e.length}return minCount=1/0,maxCount=-(1/0),$.each(e,function(e,n){r[e]=new Country(n),r[e].Count>maxCount&&(maxCount=r[e].Count),r[e].Count<minCount&&(minCount=r[e].Count)}),r}function findCountryByName(e){var r=null;return $.each(jsonCountries,function(n,o){return o.Country==e?r=o:void 0}),r}function readMinMax(e){minCount=1/0,maxCount=-(1/0);var r=[];for(var n in e)e.hasOwnProperty(n)&&r.push(n);$.each(r,function(e,r){var n=findCountryByName(r);n.Count>maxCount&&(maxCount=n.Count),n.Count<minCount&&(minCount=n.Count)})}function createFiltersBoxCheckboxes(){$("filter-box").append('<ul class="nav navbar-nav" id="filterBoxCheckboxes" style="border-style: solid; border-width: 2px;"></ul>'),$.each(jsonFiltersArray,function(e,r){function n(e){return"<p>"+JSON.stringify(e)+"</p>"}function o(){var e=$("p.status").empty();e.append(n(widget.checked()))}var t="#box"+(e+1);$("#filterBoxCheckboxes").append('<li class="col-sm-6" id="box'+(e+1)+'" class="dropdown-checkbox-example dropdown-checkbox dropdown"></li>');var a=[];$.each(r.Values,function(e,r){a.push({id:e+1,label:r,isChecked:!1})});var i=r.Name.toLowerCase();i=i.charAt(0).toUpperCase()+i.slice(1),$(t).dropdownCheckbox({data:a,autosearch:!0,hideHeader:!1,showNbSelected:!1,templateButton:'<a class="dropdown-checkbox-toggle" data-toggle="dropdown" href="#">'+i+'<span class="dropdown-checkbox-nbselected"></span><b class="caret"></b>'}),widget=$(t).data("dropdownCheckbox"),$("body").on("change:dropdown-checkbox checked checked:all check:all uncheck:all check:checked uncheck:checked",o()),o()});var e='<div id="filters_box" class="row col-sm-12"><button id="filter_box_apply_filters" type="button" class="btn btn-primary col-sm-4 col-sm-offset-1">Filter</button><button id="filter_box_reset_filters" type="button" class="btn btn-primary col-sm-4 col-sm-offset-1">Reset</button></div>';$("#filterBoxCheckboxes").append(e),$("#filter_box_apply_filters").click(function(){for(var e={},r=jsonFiltersArray.length,n=0,o=0;o<jsonFiltersArray.length;o++){for(var t="#box"+(o+1),a=getSelectedItems(t),i=[],s=Object.keys(a),l=0;l<s.length;l++)i.push(a[s[l]].label);s.length>0?e[jsonFiltersArray[o].Name]=i.join():n++}n!=r&&filter(e)}),$("#filter_box_reset_filters").click(function(){resetFiltersBox()})}function getSelectedItems(e){return $(e).dropdownCheckbox("checked")}function createFiltersBoxWithEnumeration(e){e.length;$.each(e,function(e,r){var n=r.Name.toLowerCase();n=n.charAt(0).toUpperCase()+n.slice(1);var o="";o+="<p><b>"+n+":</b></p>",o+='<div class="form-group">',o+='<input type="text" class="form-control" id="fbox'+e+'"';var t=r.Values;o+='placeholder="'+t+'" +>',o+="</div>",$("filter-box").append(o),$("#filter-box").tooltip({title:"Use this filter box to filter by multiple filters",placement:"bottom"})});var r='<div id="filters_box"><button id="filter_box_apply_filters" type="button" class="btn btn-primary col-sm-4 col-sm-offset-1">Filter</button><button id="filter_box_reset_filters" type="button" class="btn btn-primary col-sm-4 col-sm-offset-1">Reset</button></div>';$("filter-box").append(r),$("#filter_box_apply_filters").click(function(){for(var r={},n=e.length,o=0,t=0;t<e.length;t++){var a="#fbox"+t,i=$(a).val();""!==i?r[e[t].Name]=i:o++}o!=n&&filter(r)}),$("#filter_box_reset_filters").click(function(){resetFiltersBox()})}function getAllFilterValues(e){var r=[];if(-1!=String(e).indexOf(",")){var n=String(e).split(",");$.each(n,function(e,n){if(-1!=n.indexOf("-")){var o=String(n).split("-");checkFilterValuesAreValid(filterObject,o);for(var t=o[0],a=o[1];a>=t;t++)r.push(t)}else r.push(n)})}else if(-1!=e.indexOf("-")){var o=String(e).split("-");checkFilterValuesAreValid(filterObject,o);for(var t=o[0],a=o[1];a>=t;t++)r.push(t)}else r.push(e);return r}function checkWhatCountriesToAdd(e,r){var n=[];return $.each(jsonCountries,function(e,o){for(var t=0;;){t++;var a="Name"+t,i="Value"+t;if(!o[a])break;o[i]==r&&(countryValueToCheck=i,o[i]==r&&(n[o.Country]=o.Count))}}),n}function checkWhatMarkersToAdd(e,r){var n=[];return $.each(jsonMarkers,function(o,t){for(var a=0;;){a++;var i="Name"+a,s="Value"+a;if(!t[i])break;t[i]==e.Name&&t[s]==r&&n.push(t)}}),n}function checkWhatCountriesMarkersToAdd(e,r){var n=[],o=[];return n=checkWhatCountriesToAdd(e,r),o=checkWhatMarkersToAdd(e,r),[n,o]}function checkFilterNameIsValid(e){var r=!1;return $.each(jsonFiltersArray,function(n,o){return o.Name.toLowerCase()===e.toLowerCase()?(filterObject=o,void(r=!0)):void 0}),r}function checkFilterValuesAreValid(e,r){var n=!1;return $.each(r,function(e,r){$.each(filterObject.Values,function(e,o){return o==r?void(n=!0):void 0}),!n}),n}function addMarkersToMap(e){$.each(e,function(e,r){map.addMarker(e,{latLng:[r.Latitude,r.Longitude],name:r.desc,style:{fill:"green",r:mapRange(r.Count,minCount,maxCount,minRadius,maxRadius)}})})}function resetFilters(){var e=generateColorsForTheCountries();reloadMap(e),$.each(jsonMarkers,function(e,r){map.addMarker(e,{latLng:[r.Latitude,r.Longitude],name:r.desc,style:{fill:"green",r:mapRange(r.Count,minCount,maxCount,minRadius,maxRadius)}})})}function filterFromMenuSelected(e,r){currentFilter=e;var n=checkWhatCountriesToAdd(e,r);if(reloadMap(n),$.each(jsonMarkers,function(n,o){for(var t=0;;){t++;var a="Name"+t,i="Value"+t;if(!o[a])break;o[a]===e.Name&&o[i]===r&&map.addMarker(n,{latLng:[o.Latitude,o.Longitude],name:o.desc,style:{fill:"green",r:mapRange(o.Count,minCount,maxCount,minRadius,maxRadius)}})}}),isNaN(e.Values[0]))$("#slider").hide(),$("#minSlider").hide(),$("#maxSlider").hide();else{$("#slider").show(),$("#minSlider").show(),$("#maxSlider").show();var o=$("#slider").slider(),t=e.Values[0],a=e.Values[e.Values.length-1];o.slider("option","min",t),o.slider("option","max",a),$("#minSlider").text(t),$("#maxSlider").text(a)}}function sliderChanged(){var e=slider.slider("option","values"),r=e[0],n=e[1],o=currentFilter.Name;$("#minSlider").text(r),$("#maxSlider").text(n);var t=[];$.each(jsonCountries,function(e,o){var a=+o[countryValueToCheck];a>=r&&n>=a&&(t[o.Country]=o.Count)}),reloadMap(t);for(var a,i=jsonCountries[0],s=0;;){s++;var l="Name"+s,u="Value"+s;if(i[l]===o){a=u;break}}$.each(jsonMarkers,function(e,o){o[a]>=r&&o[a]<=n&&map.addMarker(e,{latLng:[o.Latitude,o.Longitude],name:o.desc,style:{fill:"green",r:mapRange(o.Count,minCount,maxCount,minRadius,maxRadius)}})})}function readFiltersFromJSON(e){for(var r=[],n=0;n<e.values.length;n++){currentFilter=e.values[n];for(var o=currentFilter.name,t=currentFilter.value,a=[],i=0;i<currentFilter.values.length;i++)a.push(currentFilter.values[i]);r[n]=new Filter(o,t,a)}return numFilters=r.length,r}function jsonMapCountries(e,r){var n=[];$.getJSON(r,function(r){$.each(e,function(e,o){var t=o[r.Country],a=0;n[e]=new Country("",t,a)}),mappingCountries=n})}function jsonMapMarkers(e,r){var n=[];$.getJSON(r,function(r){$.each(e,function(e,o){var t=o[r.Country],a=0,i=o[r.Latitude],s=o[r.Longitude];n[e]=new Marker("",t,a,i,s)}),mappingMarkers=n})}function reloadMap(e){if(map.params.map==mType){jsonCountries.length>0&&readMinMax(e);var r={vertical:!0},n={scale:[minColorMap,maxColorMap],values:[minCount,maxCount],legend:r},o={scale:[minColorMap,maxColorMap],values:[minCount,maxCount]};finalMarkersInMap=n,"markers"==dataType&&(finalMarkersInMap=o),$("#"+mDiv).empty(),map=new jvm.Map({map:mType,backgroundColor:background,container:$("#"+mDiv),onRegionClick:function(e,r){countryCode=r.toLowerCase();var n=countryCode+"_mill_en";switchMap(n)},onMarkerTipShow:function(e,r,n){var o=buildMarkerTooltip(jsonMarkers,n);r.html(o)},onRegionTipShow:function(e,r,n){var o=-1;if($.each(jsonCountries,function(e,r){return r.Country===n?void(o=r):void 0}),-1!=o){var t=buildCountryTooltip(r,o);r.html(t)}else r.html(r.html())},series:{markers:[finalMarkersInMap],regions:[{scale:[minColorMap,maxColorMap],attribute:"fill",values:e}]}})}else jsonCountries.length>0&&readMinMax(e),$("#"+mDiv).empty(),removeTooltip(),switchMap(mapType)}function removeTooltip(){$(".jvectormap-tip").remove()}function switchMap(e){$("#"+mDiv).empty(),removeTooltip();var r=generateColorsForTheRegions(e);map=new jvm.Map({map:e,backgroundColor:background,container:$("#"+mDiv),onMarkerTipShow:function(e,r,n){var o=buildMarkerTooltip(jsonMarkers,n);r.html(o)},onRegionTipShow:function(r,n,o){var t=e.split("_")[0].toUpperCase(),a=-1;$.each(jsonCountries,function(e,r){return r.Country==t?void(a=r):void 0});var i,s=!1;$.each(map.regions,function(e,r){return r.name==o?(i=r,void(s=!0)):void 0}),n.html(s?buildRegionTooltip(i):n.html())},series:{markers:[{scale:[minColorMap,maxColorMap],values:[minCount,maxCount],legend:{vertical:!0}}],regions:[{scale:[minColorMap,maxColorMap],attribute:"fill",values:r}]}}),$("#my_map").append('<div class="jvectormap-goback">Back</div>'),$(".jvectormap-goback").click(function(){$("#"+mDiv).empty(),removeTooltip(),map=new jvm.Map({container:$("#"+mDiv),map:mType,backgroundColor:background,onRegionClick:function(e,r){countryCode=r.toLowerCase();var n=countryCode+"_mill_en";switchMap(n)},onMarkerTipShow:function(e,r,n){var o=buildMarkerTooltip(jsonMarkers,n);r.html(o)},onRegionTipShow:function(e,r,n){var o=-1;if($.each(jsonCountries,function(e,r){return r.Country===n?void(o=r):void 0}),-1!=o){var t=buildCountryTooltip(r,o);r.html(t)}else r.html(r.html())},series:{markers:[{scale:[minColorMap,maxColorMap],values:[minCount,maxCount],legend:{vertical:!0}}],regions:[{scale:[minColorMap,maxColorMap],attribute:"fill",values:auxColors}]}}),thereAreMarkers&&addMarkersToMap()}),thereAreMarkers&&addMarkersToMap(),jsonCountries}function addMarkersToMap(){$.each(filteredMarkers,function(e,r){map.addMarker(e,{latLng:[r.Latitude,r.Longitude],name:r.desc,style:{fill:"green",r:mapRange(r.Count,minCount,maxCount,minRadius,maxRadius)}})})}function readMarkersFromJSON(e){var r=[];return minCount=1/0,maxCount=-(1/0),$.each(e,function(e,n){r[e]=new Marker(n);var o=r[e].Count;o>maxCount&&(maxCount=o),o<minCount&&(minCount=o)}),r}function filter(e){var r=Object.keys(e),n=r.length,o=0,t=new Array,a=new Array;for(l=0;n>l;l++)t[l]=new Array,a[l]=new Array;var i=!1;if($.each(r,function(e,r){return"all"==r.toLowerCase()?(i=!0,resetFilters(),void resetFiltersBox()):void 0}),!i){$.each(r,function(r,n){if(checkFilterNameIsValid(n)){var i=e[n],s=getAllFilterValues(i);o++,$.each(s,function(e,n){var o=checkWhatCountriesMarkersToAdd(filterObject,n),i=o[0],s=o[1];$.each(Object.keys(i),function(e,n){var o=i[n];t[r][n]=o}),$.each(s,function(e,n){a[r].push(n)})})}});var s=[];if(t.length>0){s=t[0];for(var l=0;l<t.length-1;l++)s=getCountriesIntersection(s,t[l+1])}if(reloadMap(s),filteredMarkers=[],a.length>0){filteredMarkers=a[0];for(var l=0;l<a.length-1;l++)filteredMarkers=getMarkersIntersection(filteredMarkers,a[l+1])}addMarkersToMap()}}function getMarkersIntersection(e,r){var n=[];return $.each(e,function(e,o){var t=o.Country;$.each(r,function(e,r){var a=r.Country;t==a&&n.push(o)})}),n}function getCountriesIntersection(e,r){var n=[];return $.each(Object.keys(e),function(o,t){$.each(Object.keys(r),function(r,o){t==o&&(n[t]=e[t])})}),n}function applyMultipleFiltersProgramattically(e){var r=Object.keys(e),n=r.length,o=[],t=[];$.each(r,function(r,n){e[n]});var a=[];map.removeAllMarkers(),$.each(jsonCountries,function(n,t){o[n]=0,$.each(r,function(r,a){for(var i=0;;){i++;var s="Name"+i,l="Value"+i;if(!t[s])break;t[s].toLowerCase()==a.toLowerCase()&&t[l]==e[a]&&o[n]++}})}),$.each(jsonCountries,function(e,r){o[e]==n&&(a[r.Country]=r.Count)}),reloadMap(a),$.each(jsonMarkers,function(n,o){t[n]=0,$.each(r,function(r,a){for(var i=0;;){i++;var s="Name"+i,l="Value"+i;if(!o[s])break;o[s].toLowerCase()==a.toLowerCase()&&o[l]==e[a]&&t[n]++}})}),$.each(jsonMarkers,function(e,r){t[e]==n&&map.addMarker(e,{latLng:[r.Latitude,r.Longitude],name:r.desc,style:{fill:"green",r:mapRange(r.Count,minCount,maxCount,minRadius,maxRadius)}})})}function applyMultipleFilters(e,r){var n=e.filter(function(e){return void 0!==e}).length,o=[],t=[];$.each(jsonCountries,function(n,t){o[n]=0,$.each(e,function(e,a){for(var i=0;;){i++;var s="Name"+i,l="Value"+i;if(void 0==t[s])break;t[s]===r[e].Name&&t[l]==a&&o[n]++}})});var a=[];$.each(jsonCountries,function(e,r){o[e]==n&&(a[r.Country]=r.Count)}),reloadMap(a),$.each(jsonMarkers,function(n,o){t[n]=0,$.each(e,function(e,a){for(var i=0;;){i++;var s="Name"+i,l="Value"+i;if(!o[s])break;o[s].toLowerCase()==r[e].Name.toLowerCase()&&o[l]==a&&t[n]++}})}),$.each(jsonMarkers,function(e,r){t[e]==n&&map.addMarker(e,{latLng:[r.Latitude,r.Longitude],name:r.desc,style:{fill:"green",r:mapRange(r.Count,minCount,maxCount,minRadius,maxRadius)}})})}function readRegionsFromJSON(e,r){var n=[];return $.each(e,function(e,o){n[e]=new Region(o,r)}),e}function generateColorsForTheRegions(e){var r=e.split("_")[0].toUpperCase(),n=[];return $.each(jsonCountries,function(e,o){if(o.Country==r&&o.Regions){var t=o.Regions;$.each(t,function(e,r){n[r.name]=100})}}),n}function addRegionsToMap(e){var r=e.split("_")[0].toUpperCase();$.each(jsonCountries,function(e,n){function o(){var e,r={};r[maps.region];for(e in maps.regions)r[e]=t[Math.floor(Math.random()*t.length)];return r}if(n.Country==r&&n.Regions){var t=(n.Regions,["#66C2A5","#FC8D62","#8DA0CB","#E78AC3","#A6D854"]);maps.series.regions[0].setValues(o())}})}var vectorMap,jsonFilters=[],minColorMap,maxColorMap,mDiv,mType,background,filteredMarkers,thereAreMarkers=!1,VectorialMap=function(){};VectorialMap.prototype.createMap=function(e,r,n,o,t,a,i,s,l){if(background=s,mType=i,jsonCountries=[],jsonMarkers=[],mDiv=o,minColorMap=t,maxColorMap=a,"countries"==l)jsonCountries=readCountriesFromJSON(e);else{if("markers"!=l)return;thereAreMarkers=!0,jsonMarkers=readMarkersFromJSON(e),filteredMarkers=jsonMarkers,numMarkers=jsonMarkers.length}auxColors=generateColorsForTheCountries(),jQuery.ajax({url:"../tooltip-templates/country_tooltip.html",success:function(e){countryTooltip=e},async:!1}),jQuery.ajax({url:"../tooltip-templates/marker_tooltip.html",success:function(e){markerTooltip=e},async:!1}),jQuery.ajax({url:"../tooltip-templates/region_tooltip.html",success:function(e){regionTooltip=e},async:!1});var u={vertical:!0},c={scale:[minColorMap,maxColorMap],values:[minCount,maxCount],legend:u},d={scale:[minColorMap,maxColorMap],values:[minCount,maxCount]};finalMarkersInMap=c,"markers"==l&&(finalMarkersInMap=d),map=new jvm.Map({container:$("#"+o),map:mType,backgroundColor:background,onRegionClick:function(e,r){countryCode=r.toLowerCase();var n=countryCode+"_mill_en";switchMap(n)},onMarkerTipShow:function(e,r,n){var o=buildMarkerTooltip(jsonMarkers,n);r.html(o)},onRegionTipShow:function(e,r,n){var o=-1;if($.each(jsonCountries,function(e,r){return r.Country===n?void(o=r):void 0}),-1!=o){var t=buildCountryTooltip(r,o);r.html(t)}else r.html(r.html())},series:{markers:[finalMarkersInMap],regions:[{scale:[minColorMap,maxColorMap],attribute:"fill",values:auxColors}]}}),"markers"==l&&(filteredMarkers=jsonMarkers,addMarkersToMap())},VectorialMap.prototype.filterOnServer=function(e){$.getJSON("../json/serverFilter.json",function(e){var r=JSON.stringify(e),n="http://serverFiltering.com/?data="+encodeURIComponent(r);n="../json/countries_plus_markers2.json",$.getJSON(n,function(e){jsonCountries=readCountriesFromJSON(e.countries);var r=generateColorsForTheCountries(jsonCountries);reloadMap(r),e.markers&&(jsonMarkers=readMarkersFromJSON(e.markers),addMarkersToMap())})})};var Country=function(e,r,n){if(""==e)this.Country=r,this.Count=+n,this.Var=0,this.desc="abc";else{var o=!0,t=0;do{t++;var a="Name"+t,i="Value"+t;void 0===e[a]?o=!1:(this[a]=e[a],this[i]=e[i])}while(o);e.Regions&&(this.Regions=readRegionsFromJSON(e.Regions,e.Country)),this.Country=e.Country,this.Count=+e.Count,this.Var=e.Var,this.desc="abc"}},resetFiltersBox=function(){for(var e=0;numFilters>e;e++)$("#fbox"+e).text(""),$("#fbox"+e).val("");var r=generateColorsForTheCountries();reloadMap(r),filteredMarkers=jsonMarkers,addMarkersToMap()},Filter=function(e,r,n){this.Name=e,this.Value=r,this.Values=n},numFilters,currentFilter,countryValueToCheck;VectorialMap.prototype.createSlider=function(){slider=$("#slider").slider(),slider.slider("option","min",minRadius),slider.slider("option","max",maxRadius),slider.slider("option","range",!0),slider.slider("option","animate","slow"),slider.on("slidechange",function(e,r){sliderChanged()}),$("#slider").hide(),$("#minSlider").hide(),$("#maxSlider").hide()};var mappingMarkers=[],mappingCountries=[];VectorialMap.prototype.registerTransformer=function(e,r,n){var r="../mappingJSON/mappingCountriesSample.json",n="../mappingJSON/mappingMarkersSample.json";r&&n&&(e="../json/espid-spain.json",$.getJSON(e,function(e){jsonMapCountries(e,r),jsonMapMarkers(e,n)}))};var Marker=function(e,r,n,o,t){if(""==e)this.Country=r,this.Count=+n,this.Var="",this.Latitude=o,this.Longitude=t,this.desc="abc";else{var a=!0,i=0;do{i++;var s="Name"+i,l="Value"+i;e[s]?(this[s]=e[s],this[l]=e[l]):a=!1}while(a);this.Country=e.Country,this.Count=+e.Count,this.Var=e.Var,this.Latitude=e.Latitude,this.Longitude=e.Longitude,this.desc="abc"}},Region=function(e,r){this.Region=e.name,this.Country=r,this.desc="just a region..."};